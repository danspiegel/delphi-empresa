unit uUsuarios;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Mask, Vcl.DBCtrls,
  Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls, Vcl.ToolWin, Data.DB, Data.FMTBcd,
  Data.SqlExpr, System.Actions, Vcl.ActnList;

type
  TuFrmUsuarios = class(TForm)
    ToolBar1: TToolBar;
    tbtnCriarUsuario: TToolButton;
    tbtnGravarUsuario: TToolButton;
    tbtnCancelarUsuario: TToolButton;
    tbtnSairUsuario: TToolButton;
    edtNomeUsuario: TDBEdit;
    Label1: TLabel;
    dsCadastroUsuarios: TDataSource;
    dbgUsuario: TDBGrid;
    QVerifLogin: TSQLQuery;
    tbtnExcluirUsuario: TToolButton;
    edtSenhaUsuario: TDBEdit;
    edtConfirmarSenhaUsuario: TDBEdit;
    Label2: TLabel;
    Label3: TLabel;
    ActionMenuUsers: TActionList;
    StatusEditUser: TAction;
    StatusNormalUser: TAction;
    procedure tbtnSairUsuarioClick(Sender: TObject);
    procedure tbtnCriarUsuarioClick(Sender: TObject);
    procedure tbtnGravarUsuarioClick(Sender: TObject);
    procedure tbtnCancelarUsuarioClick(Sender: TObject);
    procedure dbgUsuarioKeyPress(Sender: TObject; var Key: Char);
    procedure tbtnSenhaUsuarioClick(Sender: TObject);
    procedure tbtnExcluirUsuarioClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtSenhaUsuarioKeyPress(Sender: TObject; var Key: Char);
    procedure edtConfirmarSenhaUsuarioKeyPress(Sender: TObject; var Key: Char);
    procedure StatusEditUserExecute(Sender: TObject);
    procedure StatusNormalUserExecute(Sender: TObject);
    procedure edtNomeUsuarioChange(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  uFrmUsuarios: TuFrmUsuarios;

implementation

{$R *.dfm}

uses uDMBanco, uCadastroSenha;

procedure TuFrmUsuarios.edtSenhaUsuarioKeyPress(Sender: TObject; var Key: Char);
begin
  if not( key in['0'..'9',#08] ) then
    key:=#0;
end;

procedure TuFrmUsuarios.edtConfirmarSenhaUsuarioKeyPress(Sender: TObject; var Key: Char);
begin
  if not( key in['0'..'9',#08] ) then
    key:=#0;
end;

procedure TuFrmUsuarios.edtNomeUsuarioChange(Sender: TObject);
begin
  StatusEditUser.Execute;
  DMBanco.cdsUsuario.Edit;
end;

procedure TuFrmUsuarios.dbgUsuarioKeyPress(Sender: TObject; var Key: Char);
begin
  Key:= Upcase(Key);
end;

procedure TuFrmUsuarios.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action:= caFree;
  uFrmUsuarios:= nil;
end;

procedure TuFrmUsuarios.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = Vk_Escape) then
    tbtnSairUsuario.Click;
end;

procedure TuFrmUsuarios.tbtnCancelarUsuarioClick(Sender: TObject);
begin
  DMBanco.cdsUsuario.Delete;
  DMBanco.cdsUsuario.Cancel;
  tbtnCriarUsuario.Enabled:= true;
  tbtnGravarUsuario.Enabled:= false;
  tbtnCancelarUsuario.Enabled:= false;
end;

procedure TuFrmUsuarios.tbtnCriarUsuarioClick(Sender: TObject);
begin
  StatusEditUser.Execute;
  dbgUsuario.ReadOnly:= false;

  With edtSenhaUsuario
    Do Begin
      Enabled:= true;
      Color:= clWindow;
  end;

  With edtConfirmarSenhaUsuario
    Do begin
      Enabled:= true;
      Color:= clWindow;
  end;

  With DMBanco
    Do begin
      sdsUsuario.Open;
      cdsUsuario.Insert;
      dbgUsuario.SetFocus;
  end;
end;

procedure TuFrmUsuarios.tbtnExcluirUsuarioClick(Sender: TObject);
begin
  If (dbgUsuario.SelectedField.Text = 'MESTRE')
    Then MessageDlg('O usuário MESTRE não pode ser excluído!', mtInformation, [mbOK], 0)
  Else If (MessageBox(handle, pWideChar ('Deseja excluir o usuário '+dbgUsuario.SelectedField.Text+'?'), 'Atenção', MB_ICONQUESTION + MB_YESNO) = mrYes)
    Then begin
      DMBanco.cdsUsuario.Delete;
      DMBanco.cdsUsuario.ApplyUpdates(0);
      if (DMBanco.cdsUsuario.IsEmpty)
        Then tbtnExcluirUsuario.Enabled:= false;
  end;
end;

procedure TuFrmUsuarios.tbtnGravarUsuarioClick(Sender: TObject);
begin
  If (DMBanco.cdsUsuario.State in [dsInsert, dsEdit])
    Then begin
      If (dbgUsuario.SelectedField.Text = '')
        Then MessageDlg('Campo código é obrigatório.',mtInformation, [mbOK], 0)
      Else If (edtNomeUsuario.Text = '')
        Then begin
          MessageDlg('Campo nome é obrigatório.', mtInformation, [mbOK], 0);
          edtNomeUsuario.SetFocus;
      end
      Else If (edtSenhaUsuario.Text = '')
        Then begin
          MessageDlg('Campo senha é obrigatório.', mtInformation, [mbOK], 0);
          edtSenhaUsuario.SetFocus;
      end
      Else If (edtSenhaUsuario.Text = '')
        Then begin
          MessageDlg('Campo confirmação de senha é obrigatório.', mtInformation, [mbOK], 0);
          edtConfirmarSenhaUsuario.SetFocus;
      end
      Else If (edtConfirmarSenhaUsuario.Text = edtSenhaUsuario.Text)
        Then begin
          Try
            With QVerifLogin
              Do begin
                Active:= false;
                SQL.Clear;
                SQL.Add('SELECT idusuario FROM usuario WHERE idusuario = "'+dbgUsuario.SelectedField.Text+'"');
                Active:= true;
            end;
            If not QVerifLogin.IsEmpty
              Then MessageDlg('Campo código já existe!', mtWarning, [mbOK], 0)
            Else begin
              DMBanco.cdsUsuario.Post;
              DMBanco.cdsUsuario.ApplyUpdates(0);
              StatusNormalUser.Execute;
            end;
          Except
            On e: exception
              Do MessageDlg('Falha durante a gravação: '+ E.Message, mtWarning, [mbOK], 0);
          end;
      end
      Else begin
        MessageDlg('As senhas não correspondem.', mtInformation, [mbOK], 0);
        edtConfirmarSenhaUsuario.SetFocus;
      end;
  end
  Else If (DMBanco.cdsUsuario.State in [dsEdit])
    Then DMBanco.cdsUsuario.Edit;

end;

procedure TuFrmUsuarios.tbtnSairUsuarioClick(Sender: TObject);
begin
  If DMBanco.cdsUsuario.State in [dsInsert, dsEdit]
    Then begin
      If MessageBox('As alterações ainda não foram salvas. Deseja salvá-las?', 'Atenção', mb_YesNoCancel+mb_ICONQUESTION) = mrYes
        Then tbtnGravarUsuario.Click
      Else If MessageBox('As alterações ainda não foram salvas. Deseja salvá-las?', 'Atenção', mb_YesNoCancel+mb_ICONQUESTION) = mrNo
        Then begin
          DMBanco.cdsUsuario.CancelUpdates;
          Close;
        end;
  end
  Else Close;
end;

procedure TuFrmUsuarios.tbtnSenhaUsuarioClick(Sender: TObject);
begin
  uFrmCadastroSenha.verificadorsenha:= 2;
  uFrmCadastroSenha:= TuFrmCadastroSenha.Create(Application);
  uFrmCadastroSenha.ShowModal;
end;

procedure TuFrmUsuarios.StatusEditUserExecute(Sender: TObject);
begin
  tbtnCriarUsuario.Enabled:= false;
  tbtnGravarUsuario.Enabled:= true;
  tbtnCancelarUsuario.Enabled:= true;
  tbtnExcluirUsuario.Enabled:= false;
  tbtnSairUsuario.Enabled:= true;
end;

procedure TuFrmUsuarios.StatusNormalUserExecute(Sender: TObject);
begin
  tbtnCriarUsuario.Enabled:= true;
  tbtnGravarUsuario.Enabled:= false;
  tbtnCancelarUsuario.Enabled:= true;
  tbtnExcluirUsuario.Enabled:= true;
  tbtnSairUsuario.Enabled:= true;
end;

end.
